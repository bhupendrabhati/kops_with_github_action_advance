name: 03. KOPS Provision
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (dev / stage / prod)"
        required: true
        default: dev

      cluster_name:
        description: "Cluster name (e.g. dev.k8s.local)"
        required: true

      aws_region:
        required: true
        default: ap-south-1
        description: "AWS region"

      state_bucket:
        required: true
        description: "Terraform backend and KOPS S3 bucket name"

      ssh_cidr:
        description: "SSH access CIDR"
        required: true
        default: 0.0.0.0/0

      control_plane_count:
        description: "Control plane nodes (1–3)"
        required: true
        default: "3"

      control_plane_size:
        description: "Control plane instance type"
        required: true
        default: t3.medium

      worker_count:
        description: "Worker nodes (1–5)"
        required: true
        default: "2"

      worker_size:
        description: "Worker node instance type"
        required: true
        default: t3.small

jobs:
  kops:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kOps
        run: |
          curl -Lo kops https://github.com/kubernetes/kops/releases/latest/download/kops-linux-amd64
          chmod +x kops
          sudo mv kops /usr/local/bin/

      - name: Create kOps cluster
        id: kops_create
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          CLUSTER_NAME: ${{ inputs.cluster_name }}
          AWS_REGION: ${{ inputs.aws_region }}
          STATE_BUCKET: ${{ inputs.state_bucket }}
          SSH_CIDR: ${{ inputs.ssh_cidr }}
          CONTROL_PLANE_COUNT: ${{ inputs.control_plane_count }}
          CONTROL_PLANE_SIZE: ${{ inputs.control_plane_size }}
          WORKER_COUNT: ${{ inputs.worker_count }}
          WORKER_SIZE: ${{ inputs.worker_size }}
          KOPS_STATE_STORE: s3://${{ inputs.state_bucket }}/kops
        run: |
          bash kops/scripts/create.sh
      
      - name: Rollback kOps on failure
        if: failure()
        env:
          CLUSTER_NAME: ${{ inputs.cluster_name }}
          STATE_BUCKET: ${{ inputs.state_bucket }}
          KOPS_STATE_STORE: s3://${{ inputs.state_bucket }}/kops
        run: |
          echo "❌ kOps failed, deleting cluster"
          bash kops/scripts/delete.sh || true